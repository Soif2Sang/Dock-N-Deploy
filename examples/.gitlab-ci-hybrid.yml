stages:
  - test
  - build
  - deploy

# Test stage - Runs in Docker container
test:
  stage: test
  image: golang:1.21-alpine
  script:
    - go test ./...
    - go vet ./...

# Build stage - Builds Docker image and pushes to registry
build:
  stage: build
  image: docker:latest
  script:
    - docker build -t myregistry.com/myapp:$CI_COMMIT_SHA .
    - docker tag myregistry.com/myapp:$CI_COMMIT_SHA myregistry.com/myapp:latest
    - docker login -u $REGISTRY_USER -p $REGISTRY_PASSWORD myregistry.com
    - docker push myregistry.com/myapp:$CI_COMMIT_SHA
    - docker push myregistry.com/myapp:latest

# Deploy stage - Deploys to Kubernetes
deploy:
  stage: deploy
  image: bitnami/kubectl:latest
  type: kubernetes-deploy
  script:
    - kubectl set image deployment/myapp myapp=myregistry.com/myapp:$CI_COMMIT_SHA -n production
    - kubectl rollout status deployment/myapp -n production --timeout=5m
  properties:
    namespace: production
    deployment_name: myapp
    image_name: myregistry.com/myapp
    image_tag: $CI_COMMIT_SHA