stages:
  - test
  - build
  - deploy

test:
  stage: test
  image: alpine:latest
  script:
    - echo "Running tests..."
    - echo "Tests passed!"

build:
  stage: build
  image: docker:latest
  script:
    - docker build -t myapp:$CI_COMMIT_SHA .
    - docker tag myapp:$CI_COMMIT_SHA myregistry.com/myapp:latest
    - docker push myregistry.com/myapp:$CI_COMMIT_SHA
    - docker push myregistry.com/myapp:latest

deploy:
  stage: deploy
  image: bitnami/kubectl:latest
  type: kubernetes-deploy
  script:
    - kubectl set image deployment/myapp myapp=myregistry.com/myapp:$CI_COMMIT_SHA
    - kubectl rollout status deployment/myapp
  properties:
    namespace: production
    deployment_name: myapp
    image_name: myregistry.com/myapp
    kubeconfig: /path/to/kubeconfig